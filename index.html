<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>6th Form Network Map</title>
<style>
  body, html { margin:0; padding:0; height:100%; font-family:sans-serif; }
  .wrap { display:flex; height:100vh; overflow:hidden; }
  .left { flex:1; position:relative; overflow:hidden; background:#111; }
  .topButtons { position:absolute; top:10px; left:10px; z-index:1000; }
  .topButtons button { margin-right:5px; padding:5px 10px; }
  .topButtons button.active { background:#06b6d4; color:#fff; }
  #scene { width:100%; height:100%; overflow:hidden; position:relative; }
  #mapImg { position:absolute; left:0; top:0; transform-origin:0 0; }
  .roomMarker {
    position:absolute;
    border:2px solid #06b6d4;
    background: rgba(6,182,212,0.05);
    cursor:pointer;
    box-sizing:border-box;
    z-index:10;
    transition: background 0.2s;
  }
  .roomMarker:hover { background: rgba(6,182,212,0.2); }
  .right { width:300px; background:#222; color:#fff; padding:10px; overflow-y:auto; }
  .deviceItem { padding:5px; border-bottom:1px solid #444; cursor:pointer; }
  .deviceItem:hover { background:#333; }
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
           background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:2000; }
  .modal.open { display:flex; }
  .modalCard { background:#fff; color:#000; padding:20px; max-width:500px; max-height:90%; overflow:auto; }
  .modalCard img { max-width:100%; margin-bottom:10px; }
  #togglePanel { cursor:pointer; margin-bottom:10px; display:inline-block; }
</style>
</head>
<body>
<div class="wrap">
  <div class="left" id="viewerWrap">
    <div class="topButtons">
      <button id="btnGeneral" class="active">General</button>
      <button id="btnPhysical">Physical</button>
      <button id="btnLogical">Logical</button>
    </div>
    <div id="scene">
      <img id="mapImg" src="Six Form Block general.png" alt="map">
    </div>
  </div>
  <div class="right" id="rightPanel">
    <div id="togglePanel">&lt; Collapse</div>
    <h3 id="panelTitle">Click a room</h3>
    <div class="deviceList" id="deviceList">Loading devicesâ€¦</div>
  </div>
</div>

<div id="modal" class="modal">
  <div class="modalCard">
    <button id="closeModal">Close</button>
    <h3 id="modalTitle"></h3>
    <img id="modalImg" src="">
    <div id="modalBody"></div>
  </div>
</div>

<script>
// Map switching
const mapImg = document.getElementById("mapImg");
const btnGeneral = document.getElementById("btnGeneral");
const btnPhysical = document.getElementById("btnPhysical");
const btnLogical = document.getElementById("btnLogical");
const viewerWrap = document.getElementById("scene");

const roomsData = [
  {"name":"Tech Lab","x":6431,"y":6248,"w":483,"h":168},
  {"name":"Art Room","x":6431,"y":5530,"w":471,"h":224},
  {"name":"Tourcan Room","x":6911,"y":3426,"w":397,"h":265}
  // add all rooms here...
];

let devicesByRoom = {};
const CLICK_PADDING = 50;
let scaleX=1, scaleY=1;

// Load devices from Google Sheet CSV with trimming
async function loadDevices() {
  try {
    const res = await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vQCToFK3k1AonGSbmoxSiV3Xef82IV6BRPK_9FtzwmvVHNQDIVo38M0hQHZtKTiVCvmJiJ4kBIgAzO2/pub?gid=0&single=true&output=csv");
    const text = await res.text();
    const lines = text.split("\n").filter(l => l.trim() !== "");
    const delimiter = lines[0].includes("\t") ? "\t" : ",";
    const headers = lines[0].split(delimiter).map(h=>h.trim().toLowerCase());
    const data = {};
    for(let i=1;i<lines.length;i++){
      const row = lines[i].split(delimiter);
      const room = row[0].trim();
      if(!room) continue;
      if(!data[room]) data[room]=[];
      const obj={};
      headers.forEach((h,idx)=>obj[h]= (row[idx]||"").trim());
      data[room].push(obj);
    }
    devicesByRoom = data;
  } catch(e){ console.error("Failed to load devices:",e); devicesByRoom={}; }
}

// Show devices for a room
function showDevices(roomName){
  const list = devicesByRoom[roomName]||[];
  const deviceListEl = document.getElementById("deviceList");
  deviceListEl.innerHTML="";
  if(list.length===0){ deviceListEl.textContent="No devices"; return; }
  list.forEach(d=>{
    const el=document.createElement("div");
    el.className="deviceItem";
    el.textContent=d["device name"]||"Device";
    el.addEventListener("click",()=>openModal(d));
    deviceListEl.appendChild(el);
  });
}

// Modal functions
function openModal(d){
  const modal=document.getElementById("modal");
  modal.classList.add("open");
  document.getElementById("modalTitle").textContent=d["device name"];
  document.getElementById("modalImg").src=d["image url"];
  document.getElementById("modalBody").textContent=`Type: ${d["type"]}\nNotes: ${d["notes"]}`;
}
document.getElementById("closeModal").addEventListener("click",()=>document.getElementById("modal").classList.remove("open"));

// Draw room markers
function drawMarkers(){
  document.querySelectorAll(".roomMarker").forEach(r=>r.remove());
  const rect = mapImg.getBoundingClientRect();
  scaleX = rect.width / 9348;
  scaleY = rect.height / 10632;
  roomsData.forEach(r=>{
    const div=document.createElement("div");
    div.className="roomMarker";
    div.style.left=(r.x*scaleX - CLICK_PADDING)+'px';
    div.style.top=(r.y*scaleY - CLICK_PADDING)+'px';
    div.style.width=(r.w*scaleX + CLICK_PADDING*2)+'px';
    div.style.height=(r.h*scaleY + CLICK_PADDING*2)+'px';
    div.title=r.name;
    div.addEventListener("click",()=>showDevices(r.name));
    viewerWrap.appendChild(div);
  });
}

// Map switch buttons
function setActive(btn){ document.querySelectorAll(".topButtons button").forEach(b=>b.classList.remove("active")); btn.classList.add("active"); }
btnGeneral.addEventListener("click",()=>{ mapImg.src="Six Form Block general.png"; setActive(btnGeneral); mapImg.onload=drawMarkers; });
btnPhysical.addEventListener("click",()=>{ mapImg.src="Six Form Block physical.png"; setActive(btnPhysical); mapImg.onload=drawMarkers; });
btnLogical.addEventListener("click",()=>{ mapImg.src="Six Form Block logical.png"; setActive(btnLogical); mapImg.onload=drawMarkers; });

// Right panel toggle
const rightPanel = document.getElementById("rightPanel");
document.getElementById("togglePanel").addEventListener("click",()=>{
  if(rightPanel.style.width==="0px"){ rightPanel.style.width="300px"; }else{ rightPanel.style.width="0px"; }
});

// Zoom/pan
let isPanning=false, startX, startY, origX=0, origY=0, zoom=1;
viewerWrap.addEventListener("mousedown", e=>{ isPanning=true; startX=e.clientX; startY=e.clientY; });
viewerWrap.addEventListener("mousemove", e=>{
  if(!isPanning) return;
  const dx=e.clientX-startX; const dy=e.clientY-startY;
  mapImg.style.left=(origX+dx)+"px"; mapImg.style.top=(origY+dy)+"px";
});
viewerWrap.addEventListener("mouseup", e=>{ isPanning=false; origX=parseInt(mapImg.style.left)||0; origY=parseInt(mapImg.style.top)||0; });
viewerWrap.addEventListener("mouseleave", ()=>{ isPanning=false; origX=parseInt(mapImg.style.left)||0; origY=parseInt(mapImg.style.top)||0; });
viewerWrap.addEventListener("wheel", e=>{
  e.preventDefault();
  const delta=e.deltaY>0?-0.1:0.1;
  zoom=Math.min(Math.max(0.1,zoom+delta),3);
  mapImg.style.transform=`scale(${zoom})`;
  drawMarkers();
});

// Initialize
mapImg.onload = drawMarkers;
loadDevices();
</script>
</body>
</html>
